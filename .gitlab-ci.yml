variables:
  DOCKER_REPO: "docker.sambebbington.co.uk:4999"
  DOCKER_USER: $DOCKER_USER
  DOCKER_PASSWORD: $DOCKER_PASSWORD

stages:
  - build
  - staging
  - production

build-backend-docker-image:
  image: docker:19.03.12
  stage: build
  script:
    - cd backend
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD $DOCKER_REPO
    - docker build -t $DOCKER_REPO/econplaza/app:$CI_PIPELINE_ID .
    - docker push $DOCKER_REPO/econplaza/app:$CI_PIPELINE_ID

build-frontend-docker-image:
  stage: build
  script:
    - cd frontend
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD $DOCKER_REPO
    - docker build -t $DOCKER_REPO/econplaza/frontend:$CI_PIPELINE_ID .
    - docker push $DOCKER_REPO/econplaza/frontend:$CI_PIPELINE_ID

deploy-api-staging:
  image: alpine/curl:3.14
  stage: staging
  script:
    - curl -i http://192.168.0.15:9999/blue-green/econplaza-api-staging/$CI_PIPELINE_ID
    - while [[ true ]]
      do
      $state=$(curl -s http://192.168.0.15:9999/blue-green-state/econplaza-api-staging)
      echo $state
      if [[ $state == Done* ]]
      then
      exit 0
      fi
      if [[ $state == Fail* ]]
      then
      exit 1
      fi
      sleep 5
      done
  only:
    - master

deploy-frontend-staging:
  image: alpine/curl:3.14
  stage: staging
  script:
    - curl -i http://192.168.0.15:9999/blue-green/econplaza-frontend-staging/$CI_PIPELINE_ID
    - while [[ true ]]
      do
      $state=$(curl -s http://192.168.0.15:9999/blue-green-state/econplaza-frontend-staging)
      echo $state
      if [[ $state == Done* ]]
      then
      exit 0
      fi
      if [[ $state == Fail* ]]
      then
      exit 1
      fi
      sleep 5
      done
  only:
    - master

deploy-api-production:
  image: alpine/curl:3.14
  stage: production
  script:
    - curl -i http://192.168.0.15:9999/blue-green/econplaza-api-production/$CI_PIPELINE_ID
    - while [[ true ]]
      do
      $state=$(curl -s http://192.168.0.15:9999/blue-green-state/econplaza-api-production)
      echo $state
      if [[ $state == Done* ]]
      then
      exit 0
      fi
      if [[ $state == Fail* ]]
      then
      exit 1
      fi
      sleep 5
      done
  when: manual
  only:
    - master

deploy-frontend-production:
  image: alpine/curl:3.14
  stage: production
  script:
    - curl -i http://192.168.0.15:9999/blue-green/econplaza-frontend-production/$CI_PIPELINE_ID
    - while [[ true ]]
      do
      $state=$(curl -s http://192.168.0.15:9999/blue-green-state/econplaza-frontend-production)
      echo $state
      if [[ $state == Done* ]]
      then
      exit 0
      fi
      if [[ $state == Fail* ]]
      then
      exit 1
      fi
      sleep 5
      done
  when: manual
  only:
    - master

