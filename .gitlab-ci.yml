variables:
  DOCKER_REPO: "docker.sambebbington.co.uk"
  DOCKER_USER: $DOCKER_USER
  DOCKER_PASSWORD: $DOCKER_PASSWORD

stages:
  - build
  - staging
  - production

build-backend-docker-image:
  image: docker:19.03.12 
  stage: build
  script:
    - cd backend
    - docker login $DOCKER_REPO -u $DOCKER_USER -p $DOCKER_PASSWORD
    - docker build -t $DOCKER_REPO/econplaza/app:$CI_PIPELINE_ID .
    - docker push $DOCKER_REPO/econplaza/app:$CI_PIPELINE_ID

build-frontend-docker-image:
  stage: build
  script:
    - cd frontend
    - docker login $DOCKER_REPO -u $DOCKER_USER -p $DOCKER_PASSWORD
    - docker build -t $DOCKER_REPO/econplaza/frontend:$CI_PIPELINE_ID .
    - docker push $DOCKER_REPO/econplaza/frontend:$CI_PIPELINE_ID

deploy-staging:
  image: docker:19.03.12 
  stage: staging
  script:
    - curl -i http://host.docker.internal:9999/blue-green/econplaza-api-staging/$CI_PIPELINE_ID

deploy-frontend-staging:
  image: docker:19.03.12 
  stage: staging
  script:
    - curl -i http://host.docker.internal:9999/blue-green/econplaza-frontend-staging/$CI_PIPELINE_ID

deploy-production:
  image: docker:19.03.12 
  stage: production
  script:
    - curl -i http://host.docker.internal:9999/blue-green/econplaza-api-production/$CI_PIPELINE_ID

deploy-frontend-production:
  image: docker:19.03.12 
  stage: production
  script:
    - curl -i http://host.docker.internal:9999/blue-green/econplaza-frontend-production/$CI_PIPELINE_ID

