variables:
  DOCKER_REPO: "docker.sambebbington.co.uk"

stages:
  - build
  - staging
  - production

build-backend-docker-image:
  image: docker:19.03.12 
  stage: build
  script:
    - cd backend
    - docker login $DOCKER_REPO -u $DOCKER_USER -p $DOCKER_PASSWORD
    - docker build -t $DOCKER_REPO/econplaza/app:$CI_PIPELINE_ID .
    - docker push $DOCKER_REPO/econplaza/app:$CI_PIPELINE_ID

build-frontend-docker-image:
  stage: build
  script:
    - cd frontend
    - docker login $DOCKER_REPO -u $DOCKER_USER -p $DOCKER_PASSWORD
    - docker build -t $DOCKER_REPO/econplaza/frontend:$CI_PIPELINE_ID .
    - docker push $DOCKER_REPO/econplaza/frontend:$CI_PIPELINE_ID

deploy-staging:
  image: docker:19.03.12 
  stage: staging
  script:
    - cd backend
    - sed -i "s+<<DOCKER_IMAGE>>+${DOCKER_REPO}/${GCP_PROJECT_ID}/econplaza/app:${CI_PIPELINE_ID}+g" .google/staging.yaml

deploy-frontend-staging:
  image: docker:19.03.12 
  stage: staging
  script:
    - cd frontend
    - sed -i "s+<<DOCKER_IMAGE>>+${DOCKER_REPO}/${GCP_PROJECT_ID}/econplaza/frontend:${CI_PIPELINE_ID}+g" .google/staging.yaml

deploy-production:
  image: docker:19.03.12 
  stage: production
  script:
    - cd backend
    - sed -i "s+<<DOCKER_IMAGE>>+${DOCKER_REPO}/${GCP_PROJECT_ID}/econplaza/app:${CI_PIPELINE_ID}+g" .google/production.yaml

deploy-frontend-production:
  image: docker:19.03.12 
  stage: production
  script:
    - cd frontend
    - sed -i "s+<<DOCKER_IMAGE>>+${DOCKER_REPO}/${GCP_PROJECT_ID}/econplaza/frontend:${CI_PIPELINE_ID}+g" .google/production.yaml

